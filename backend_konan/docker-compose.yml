services:
  konan_db:
    image: pgvector/pgvector:pg16
    container_name: konan_db
    restart: always
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: pass123
      POSTGRES_DB: konan_db
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 10

  konan_backend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: konan_backend
    restart: always
    depends_on:
      konan_db:
        condition: service_healthy
    env_file:
      - .env
    environment:
      DATABASE_URL: postgresql+psycopg2://postgres:pass123@konan_db:5432/konan_db
      OPENAI_API_KEY: ${OPENAI_API_KEY}
    ports:
      - "8000:8000"
    volumes:
      - .:/app
      - ./app/data:/app/app/data:rw
      - ./chroma_store:/app/chroma_store
      - ./chroma_store_laws:/app/chroma_store_laws
    command: >
      bash -c "
        echo 'ğŸ§© Attente de PostgreSQL...';
        until pg_isready -h konan_db -U postgres; do
          echo 'â³ Base non prÃªte, nouvelle tentative...';
          sleep 3;
        done;
        echo 'âœ… PostgreSQL disponible â€” migrations Alembic';
        alembic upgrade head;
        echo 'ğŸš€ Lancement du serveur FastAPI';
        uvicorn app.main:app --host 0.0.0.0 --port 8000
      "
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:8000/health"]
      interval: 15s
      timeout: 3s
      retries: 10

  pgadmin4:
    image: dpage/pgadmin4
    container_name: pgadmin4
    restart: always
    depends_on:
      - konan_db
    environment:
      PGADMIN_DEFAULT_EMAIL: "admin@konan.pro"
      PGADMIN_DEFAULT_PASSWORD: "admin123"
      PGADMIN_LISTEN_PORT: 5050
    ports:
      - "5050:5050"
    volumes:
      - pgadmin_data:/var/lib/pgadmin

  konan_backup:
    image: postgres:16
    container_name: konan_backup
    restart: always
    depends_on:
      konan_db:
        condition: service_healthy
    environment:
      PGPASSWORD: pass123
    volumes:
      - postgres_backups:/backups
    entrypoint: >
      bash -c "
        echo 'ğŸ• Service de backup PostgreSQL Konan';
        while true; do
          ts=$(date +%Y-%m-%d_%H-%M-%S);
          echo 'ğŸ’¾ Sauvegarde...';
          pg_dump -h konan_db -U postgres -d konan_db > /backups/konan_db_${ts}.sql &&
          echo 'âœ… Backup terminÃ© : konan_db_${ts}.sql';
          find /backups -type f -mtime +7 -delete;
          echo 'ğŸ§¹ Rotation terminÃ©e';
          sleep 86400;
        done
      "

volumes:
  postgres_data:
  pgadmin_data:
  postgres_backups:
